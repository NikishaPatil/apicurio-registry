name: Apicurio Registry Grades Report

on:
  schedule:
    - cron: '0 7 * * *'   # daily at 7 AM UTC
  workflow_dispatch:      # manual trigger

jobs:
  generate-report:
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Generate and email report
        env:
          REGISTRY: registry.access.redhat.com
          API: https://catalog.redhat.com/api/containers/v1/repositories
          TO_EMAIL: nipatil@redhat.com
        run: |
          IMAGE_W=90
          TAG_W=25
          GRADE_W=5

          print_header() {
            echo
            echo "$1"
            echo
            printf "%-${IMAGE_W}s %-${TAG_W}s %-${GRADE_W}s\n" "IMAGE" "TAG" "GRADE"
            printf "%-${IMAGE_W}s %-${TAG_W}s %-${GRADE_W}s\n" \
              "$(printf '%*s' "$IMAGE_W" | tr ' ' '-')" \
              "$(printf '%*s' "$TAG_W" | tr ' ' '-')" \
              "$(printf '%*s' "$GRADE_W" | tr ' ' '-')"
          }

          OUTPUT_FILE="apicurio_report.txt"
          > "$OUTPUT_FILE"

          # -----------------------------
          # 2.6.x (RHEL8)
          # -----------------------------
          REPOS_2X=(
            "apicurio/apicurio-registry-kafkasql-rhel8"
            "apicurio/apicurio-registry-sql-rhel8"
            "apicurio/apicurio-registry-rhel8-operator"
            "apicurio/apicurio-registry-operator-bundle"
          )

          OPERATOR_STREAM_PREFIX="2.6.13"

          print_header "=== Apicurio Registry 2.6.x Images ===" >> "$OUTPUT_FILE"

          for REPO in "${REPOS_2X[@]}"; do
            GRADES_JSON=$(curl -s "${API}/registry/${REGISTRY}/repository/${REPO}/grades")

            if [[ "$REPO" == *-operator && "$REPO" != *bundle ]]; then
              TAG=$(echo "$GRADES_JSON" | jq -r --arg p "$OPERATOR_STREAM_PREFIX" '
                map(select(.tag | startswith($p)))
                | sort_by(.created_at)
                | last
                | .tag
              ')

              GRADE=$(echo "$GRADES_JSON" | jq -r --arg TAG "$TAG" '
                .[] | select(.tag==$TAG) | .current_grade
              ')
            else
              GRADE=$(echo "$GRADES_JSON" | jq -r '.[] | select(.tag=="latest") | .current_grade')

              TAG=$(curl -s "${API}/registry/${REGISTRY}/repository/${REPO}/tag/latest" \
                | jq -r '
                  .data[].repositories[].tags[].name
                  | select(. != "latest")
                ' | sort -V | tail -n 1)
            fi

            printf "%-${IMAGE_W}s %-${TAG_W}s %-${GRADE_W}s\n" \
              "${REGISTRY}/${REPO}" \
              "${TAG:-N/A}" \
              "${GRADE:-N/A}" >> "$OUTPUT_FILE"
          done

          # -----------------------------
          # 3.x (RHEL9)
          # -----------------------------
          REPOS_3X=(
            "apicurio/apicurio-registry-rhel9-operator"
            "apicurio/apicurio-registry-rhel9"
            "apicurio/apicurio-registry-ui-rhel9"
            "apicurio/apicurio-registry-3-operator-bundle"
          )

          print_header "=== Apicurio Registry 3.x Images ===" >> "$OUTPUT_FILE"

          for REPO in "${REPOS_3X[@]}"; do
            GRADE=$(curl -s "${API}/registry/${REGISTRY}/repository/${REPO}/grades" \
              | jq -r '.[] | select(.tag=="latest") | .current_grade')

            TAG=$(curl -s "${API}/registry/${REGISTRY}/repository/${REPO}/tag/latest" \
              | jq -r '
                  .data[].repositories[].tags[].name
                  | select(. != "latest")
                ' | sort -V | tail -n 1)

            printf "%-${IMAGE_W}s %-${TAG_W}s %-${GRADE_W}s\n" \
              "${REGISTRY}/${REPO}" \
              "${TAG:-N/A}" \
              "${GRADE:-N/A}" >> "$OUTPUT_FILE"
          done

          # -----------------------------
          # Email the report
          # -----------------------------
          sudo apt-get install -y mailutils
          mail -s "Apicurio Registry Grades Report" "$TO_EMAIL" < "$OUTPUT_FILE"
