name: Sync and Brand Apicurio

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout your repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

      - name: Add upstream
        run: |
          git remote add upstream https://github.com/Apicurio/apicurio-registry.git || true
          git fetch upstream --tags

      # ----------------------------------
      # Sync main branch
      # ----------------------------------

      - name: Sync main with upstream
        run: |
          git fetch upstream main
          git fetch origin main

          # Avoid ambiguous branch issue
          git checkout -B main origin/main

          LOCAL=$(git rev-parse main)
          UPSTREAM=$(git rev-parse upstream/main)

          echo "Local main: $LOCAL"
          echo "Upstream main: $UPSTREAM"

          if [ "$LOCAL" != "$UPSTREAM" ]; then
            echo "Updating main branch..."
            git reset --hard upstream/main
            git push origin main --force
          else
            echo "Main already up to date."
          fi

      # ----------------------------------
      # Get latest upstream tag
      # ----------------------------------

      - name: Get latest upstream tag
        id: latest
        run: |
          LATEST=$(git describe --tags --abbrev=0 upstream/main)
          echo "latest_tag=$LATEST" >> "$GITHUB_OUTPUT"

      # ----------------------------------
      # Check if tag exists in YOUR repo
      # ----------------------------------

      - name: Check if tag exists in origin
        id: check
        run: |
          if git ls-remote --tags origin | grep -q "refs/tags/${{ steps.latest.outputs.latest_tag }}$"; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      # ----------------------------------
      # Create tag + release ONLY in your repo
      # ----------------------------------

      - name: Create branded tag
        if: steps.check.outputs.exists == 'false'
        run: |
          git tag "${{ steps.latest.outputs.latest_tag }}"
          git push origin "${{ steps.latest.outputs.latest_tag }}"

      - name: Create GitHub Release
        if: steps.check.outputs.exists == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.latest.outputs.latest_tag }}
          name: Apicurio Registry ${{ steps.latest.outputs.latest_tag }} (Branded)
          body: |
            Synced from upstream Apicurio release.
